/**
 * GitHub Sync - Auto-commit y push de SQLite a GitHub
 * Se ejecuta periÃ³dicamente para mantener GitHub actualizado
 */

import { checkpoint, getStats } from './client.js';
import { execSync } from 'child_process';

/**
 * Verificar si Git estÃ¡ configurado y funcionando
 */
export function isGitAvailable(): boolean {
  try {
    execSync('git --version', { stdio: 'ignore' });
    return true;
  } catch {
    return false;
  }
}

/**
 * Verificar si tenemos GITHUB_TOKEN configurado
 */
export function isGitHubTokenAvailable(): boolean {
  return !!process.env.GITHUB_TOKEN;
}

/**
 * Configurar Git user para commits
 */
function configureGitUser(): void {
  try {
    execSync('git config user.email "bot@enginedb.app"', { stdio: 'ignore' });
    execSync('git config user.name "EngineDB Bot"', { stdio: 'ignore' });
  } catch (error: any) {
    console.warn('âš ï¸  Warning configurando git user:', error.message);
  }
}

/**
 * Sincronizar base de datos a GitHub
 */
export async function syncDatabaseToGitHub(): Promise<{
  success: boolean;
  message: string;
  stats?: any;
}> {
  console.log('');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ“¤ SYNC: Sincronizando database a GitHub...');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

  // Verificar prerrequisitos
  if (!isGitAvailable()) {
    const message = 'Git no estÃ¡ disponible';
    console.error(`âŒ ${message}`);
    return { success: false, message };
  }

  if (!isGitHubTokenAvailable()) {
    const message = 'GITHUB_TOKEN no configurado';
    console.error(`âŒ ${message}`);
    return { success: false, message };
  }

  try {
    // Paso 1: Checkpoint WAL para consolidar cambios
    console.log('ğŸ“ Step 1/6: Haciendo checkpoint de WAL...');
    checkpoint();
    console.log('   âœ… Checkpoint completado');

    // Paso 2: Obtener estadÃ­sticas
    console.log('ğŸ“Š Step 2/6: Obteniendo estadÃ­sticas...');
    const stats = getStats();
    console.log(`   ğŸ“¦ ${stats.tables} tablas, ${stats.totalRows} registros`);
    console.log(`   ğŸ’¾ TamaÃ±o: ${(stats.sizeBytes / 1024 / 1024).toFixed(2)} MB`);

    // Paso 3: Configurar Git
    console.log('ğŸ”§ Step 3/6: Configurando Git...');
    configureGitUser();
    console.log('   âœ… Git configurado');

    // Paso 4: Verificar si hay cambios
    console.log('ğŸ” Step 4/6: Verificando cambios...');
    const dbPath = 'api/data/enginedb.sqlite';

    // Agregar archivo
    execSync(`git add ${dbPath}`, { stdio: 'ignore' });

    // Verificar si hay cambios staged
    let hasChanges = false;
    try {
      const status = execSync('git status --porcelain', { encoding: 'utf-8' });
      hasChanges = status.includes(dbPath);
    } catch (error: any) {
      console.warn('âš ï¸  Warning verificando status:', error.message);
      hasChanges = true; // Asumir que hay cambios
    }

    if (!hasChanges) {
      console.log('   â„¹ï¸  No hay cambios en la base de datos');
      return {
        success: true,
        message: 'No hay cambios',
        stats
      };
    }

    console.log('   âœ… Cambios detectados');

    // Paso 5: Commit
    console.log('ğŸ’¾ Step 5/6: Creando commit...');
    const commitMessage = `Auto-sync database - ${new Date().toISOString()}

ğŸ“Š Stats:
- Tables: ${stats.tables}
- Rows: ${stats.totalRows.toLocaleString()}
- Size: ${(stats.sizeBytes / 1024 / 1024).toFixed(2)} MB

ğŸ¤– Generated by EngineDB Bot`;

    try {
      execSync(`git commit -m "${commitMessage.replace(/"/g, '\\"')}"`, {
        stdio: 'pipe',
        encoding: 'utf-8'
      });
      console.log('   âœ… Commit creado');
    } catch (error: any) {
      // Si el error es "nothing to commit", estÃ¡ bien
      if (error.message.includes('nothing to commit')) {
        console.log('   â„¹ï¸  No hay cambios para commit');
        return {
          success: true,
          message: 'No changes to commit',
          stats
        };
      }
      throw error;
    }

    // Paso 6: Push a GitHub
    console.log('ğŸš€ Step 6/6: Pushing a GitHub...');

    // Configurar remote con token
    const token = process.env.GITHUB_TOKEN;
    const repo = process.env.GITHUB_REPO || 'adriangallery/enginedb';
    const remoteUrl = `https://x-access-token:${token}@github.com/${repo}.git`;

    try {
      // Intentar push
      execSync(`git push ${remoteUrl} HEAD:main`, {
        stdio: 'pipe',
        encoding: 'utf-8',
        timeout: 30000 // 30 segundos timeout
      });
      console.log('   âœ… Push exitoso');
    } catch (error: any) {
      // Si hay conflicto, intentar pull + rebase + push
      if (error.message.includes('rejected') || error.message.includes('non-fast-forward')) {
        console.log('   âš ï¸  Conflicto detectado, intentando pull...');

        try {
          // Pull con rebase
          execSync(`git pull ${remoteUrl} main --rebase`, {
            stdio: 'pipe',
            encoding: 'utf-8'
          });

          // Retry push
          execSync(`git push ${remoteUrl} HEAD:main`, {
            stdio: 'pipe',
            encoding: 'utf-8'
          });

          console.log('   âœ… Push exitoso despuÃ©s de rebase');
        } catch (retryError: any) {
          console.error('   âŒ Error en retry:', retryError.message);
          throw retryError;
        }
      } else {
        throw error;
      }
    }

    console.log('');
    console.log('ğŸ“Š Resumen del sync:');
    console.log(`   âœ… Database sincronizada exitosamente`);
    console.log(`   ğŸ“¦ ${stats.totalRows.toLocaleString()} registros`);
    console.log(`   ğŸ’¾ ${(stats.sizeBytes / 1024 / 1024).toFixed(2)} MB`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('');

    return {
      success: true,
      message: 'Database sincronizada exitosamente',
      stats
    };
  } catch (error: any) {
    console.error('');
    console.error('âŒ Error sincronizando a GitHub:');
    console.error('   ', error.message);
    console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.error('');

    return {
      success: false,
      message: `Error: ${error.message}`
    };
  }
}

/**
 * Verificar si el sync a GitHub estÃ¡ habilitado
 */
export function isGitHubSyncEnabled(): boolean {
  return isGitAvailable() && isGitHubTokenAvailable();
}

export default {
  syncDatabaseToGitHub,
  isGitHubSyncEnabled,
  isGitAvailable,
  isGitHubTokenAvailable,
};
